---
layout: news_post
title: "Выпуск Ruby 3.3.0-rc1"
author: "naruse"
translator: "suban05"
date: 2023-12-11 00:00:00 +0000
lang: ru
---

{% assign release = site.data.releases | where: "version", "3.3.0-rc1" | first %}
Мы рады объявить о выпуске Ruby {{ release.version }}. Ruby 3.3 добавляет новый парсер под названием Prism, использует Lrama в качестве генератора парсеров, вводит новый чисто-рубиновый JIT-компилятор под названием RJIT и множество улучшений производительности, особенно YJIT.

После выпуска RC1 мы постараемся избегать введения несовместимостей ABI, где это возможно. Если нам придется это сделать, мы объявим об этом в примечании к релизу.

## Prism

* Введен [парсер Prism](https://github.com/ruby/prism) в качестве гема по умолчанию.
    * Prism — переносимый, толерантный к ошибкам и поддерживаемый рекурсивный спускающийся парсер для языка Ruby.
* Prism готов к использованию в продакшене и активно поддерживается, его можно использовать вместо Ripper.
    * Есть [обширная документация](https://ruby.github.io/prism/), посвященная использованию Prism.
    * Prism представляет собой как библиотеку на C, которая будет использоваться внутри CRuby, так и Ruby-гем, который может использоваться любыми инструментами, нуждающимися в разборе Ruby-кода.
    * Примечательные методы в API Prism:
        * `Prism.parse(source)`, возвращающий AST в качестве части ParseResult.
        * `Prism.dump(source)`, возвращающий сериализованный AST в виде строки.
        * `Prism.parse_comments(source)`, возвращающий комментарии.
* Вы можете создавать pull request или issues напрямую на [репозитории Prism](https://github.com/ruby/prism), если хотите внести вклад.

## Использование Lrama вместо Bison

* Заменен Bison на [Lrama LALR генератор парсеров](https://github.com/ruby/lrama) [Feature #19637](https://bugs.ruby-lang.org/issues/19637).
  * Если вас это интересует, пожалуйста, ознакомьтесь с [будущим видением парсера Ruby](https://rubykaigi.org/2023/presentations/spikeolaf.html).
  * Внутренний парсер Lrama заменен на LR парсер, сгенерированный Racc для обеспечения удобства поддержки.
  * Поддерживаются параметризованные правила `(?, *, +)`, они будут использоваться в Ruby parse.y.

## RJIT

* Введен чисто-рубиновый JIT-компилятор RJIT, заменивший MJIT.
  * RJIT поддерживает только архитектуру x86-64 на платформах Unix.
  * В отличие от MJIT, он не требует компилятора C во время выполнения.
* RJIT существует исключительно в экспериментальных целях.
  * В продакшене рекомендуется продолжать использовать YJIT.
* Если вас интересует разработка JIT для Ruby, обратитесь к [презентации k0kubun на Day 3 RubyKaigi](https://rubykaigi.org/2023/presentations/k0kubun.html#day3).

## YJIT

* Значительные улучшения производительности по сравнению с 3.2.
  * Улучшена поддержка splat и rest аргументов.
  * Регистры выделяются для операций со стеком виртуальной машины.
  * Компилируются больше вызовов с опциональными аргументами.
  * Компилируются обработчики исключений.
  * Переменные экземпляра больше не выходят в интерпретатор с мегаморфными формами объектов.
  * Неподдерживаемые типы вызовов больше не возвращаются в интерпретатор.
  * `Integer#!=`, `String#!=`, `Kernel#block_given?`, `Kernel#is_a?`, `Kernel#instance_of?`, `Module#===` оптимизированы специальным образом.
  * Теперь YJIT более чем в 3 раза быстрее интерпретатора на optcarrot!
* Значительно улучшено использование памяти по сравнению с 3.2.
    * Метаданные для скомпилированного кода используют гораздо меньше памяти.
    * Генерируется более компактный код на ARM64.
* Скорость компиляции теперь немного выше, чем в 3.2.
* Добавлен `RubyVM::YJIT.enable`, который позволяет включать YJIT во время выполнения.
  * Вы можете запустить YJIT без изменения аргументов командной строки или переменных среды.
  * Это также можно использовать для включения YJIT только после загрузки вашего приложения. `--yjit-disable` можно использовать, если вы хотите использовать другие параметры YJIT при отключенном YJIT при запуске.
* Код GC теперь отключен по умолчанию, и `--yjit-exec-mem-size` рассматривается как жесткий предел, где компиляция нового кода прекращается.
  * Лучшее поведение copy-on-write на серверах, использующих unicorn и forking.
  * Нет резких снижений производительности из-за GC кода.
  * Вы всё ещё можете включить код GC по желанию с помощью `--yjit-code-gc`.
* Статистика `ratio_in_yjit`, производимая `--yjit-stats`, теперь доступна в релизных сборках, для доступа к большинству статистик больше не требуется специальная статистическая или dev сборка.
* Опция трассировки выходов теперь поддерживает выборочное сэмплирование `--trace-exits-sample-rate=N`.
* Добавлен `--yjit-perf` для упрощения профилирования с помощью Linux perf.
* Проведено более тщательное тестирование и многочисленные исправления ошибок.

### Планировщик потоков M:N

* Введен планировщик потоков M:N. [[Feature #19842]](https://bugs.ruby-lang.org/issues/19842)
  * Потоки M Ruby управляются N нативными потоками (потоками ОС), что снижает затраты на создание и управление потоками.
  * Это может нарушить совместимость с C-расширениями, поэтому планировщик потоков M:N по умолчанию отключен в основном Ractor.
      * Переменная среды `RUBY_MN_THREADS=1` активирует потоки M:N в основном Ractor.
      * Потоки M:N включены в неосновных Ractor.
  * Переменная среды `RUBY_MAX_CPU=n` устанавливает максимальное количество `N` (максимальное количество нативных потоков). По умолчанию это значение равно 8.
      * Поскольку только один Ruby-поток на Ractor может работать одновременно, будет использовано меньшее из числа, указанного в `RUBY_MAX_CPU`, и числа запущенных Ractor. Таким образом, большинство приложений с одним Ractor будут использовать 1 нативный поток.
      * Для поддержки блокирующих операций может использоваться больше `N` нативных потоков.

## Другие значимые нововведения



### Язык


## Улучшения производительности

* Оптимизирована конструкция `defined?(@ivar)` с помощью объектных форм.
* Разрешение имен, такое как `Socket.getaddrinfo`, теперь может быть прервано (в средах, где доступны pthreads). [Feature #19965](https://bugs.ruby-lang.org/issues/19965)
  * Для этой цели теперь создается pthread при каждом вызове getaddrinfo или getnameinfo. Это сопряжено с некоторыми накладными расходами на разрешение имен (приблизительно в 2.5 раза по нашим экспериментам). Мы не ожидаем, что эти накладные расходы на разрешение имен станут проблемой для большинства приложений, однако если вы заметите такое или увидите неожиданные эффекты, которые, по вашему мнению, связаны с этим изменением, пожалуйста, сообщите об этом.
* Несколько улучшений производительности сборщика мусора
  * Молодые объекты, на которые ссылаются старые объекты, больше не сразу перемещаются в старшее поколение. Это значительно снижает частоту основных сборок мусора. [[Feature #19678]](https://bugs.ruby-lang.org/issues/19678)
  * Введена новая настройка `REMEMBERED_WB_UNPROTECTED_OBJECTS_LIMIT_RATIO`, чтобы контролировать количество незащищенных объектов, вызывающих сборку основного поколения. По умолчанию установлено значение `0.01` (1%). Это значительно снижает частоту основных сборок мусора. [[Feature #19571]](https://bugs.ruby-lang.org/issues/19571)
  * Для многих основных типов были внедрены барьеры записи, в частности для `Time`, `Enumerator`, `MatchData`, `Method`, `File::Stat`, `BigDecimal` и нескольких других. Это значительно снижает время минорных сборок мусора и частоту основных сборок мусора.
  * Большинство основных классов теперь используют переменную ширину выделения памяти, в частности `Hash`, `Time`, `Thread::Backtrace`, `Thread::Backtrace::Location`, `File::Stat`, `Method`. Это делает эти классы быстрее для выделения и освобождения, использует меньше памяти и снижает фрагментацию кучи.
  * Добавлена поддержка слабых ссылок в сборщике мусора. [[Feature #19783]](https://bugs.ruby-lang.org/issues/19783)


## Другие значимые изменения с момента версии 3.2

### IRB

IRB получил ряд улучшений, включая, но не ограничиваясь:

- Расширенная интеграция `irb:rdbg`, предоставляющая аналогичный опыт отладки как `pry-byebug` ([документация](https://github.com/ruby/irb#debugging-with-irb)).
- Поддержка пейджера для команд `ls`, `show_source` и `show_cmds`.
- Более точная и полезная информация, предоставляемая командами `ls` и `show_source`.
- Экспериментальное автодополнение с использованием анализа типов ([документация](https://github.com/ruby/irb#type-based-completion)).
- Теперь возможно изменять цвет шрифта и стиль шрифта в диалоге автодополнения с помощью нового класса Reline::Face ([документация](https://github.com/ruby/ruby/blob/master/doc/reline/face.md))

Кроме того, IRB претерпел обширную рефакторизацию и получил десятки исправлений ошибок для облегчения будущих улучшений.

## Проблемы совместимости

Примечание: Исключены исправления ошибок функционала.

* Вызовы `it` без аргументов в блоке без обычных параметров устаревают. В Ruby 3.4 `it` будет ссылаться на первый параметр блока. [Feature #18980](https://bugs.ruby-lang.org/issues/18980)

### Удаленные константы

Следующие устаревшие константы удалены.



### Удаленные методы

Следующие устаревшие методы удалены.

### Удаленные переменные среды

Следующие устаревшие переменные среды удалены.

* Переменная среды `RUBY_GC_HEAP_INIT_SLOTS` устарела и не работает. Вместо нее используйте переменные среды `RUBY_GC_HEAP_{0,1,2,3,4}_INIT_SLOTS`. [Feature #19785](https://bugs.ruby-lang.org/issues/19785)

## Проблемы совместимости стандартной библиотеки

### `ext/readline` устарел

* У нас есть `reline`, чистая реализация на Ruby, совместимая с API `ext/readline`. Мы полагаемся на `reline` в будущем. Если вам нужно использовать `ext/readline`, вы можете установить `ext/readline` через rubygems.org с помощью `gem install readline-ext`.
* Теперь больше не нужно устанавливать библиотеки типа `libreadline` или `libedit`.

## Обновления C API

### Обновленные C API

Следующие API обновлены.



### Удаленные C API

Следующие устаревшие API удалены.



## Обновления стандартной библиотеки

RubyGems и Bundler предупреждают пользователей, если требуется гем, который запланирован для включения в будущих версиях Ruby.

Целевые библиотеки:

  * abbrev
  * base64
  * bigdecimal
  * csv
  * drb
  * getoptlong
  * mutex_m
  * nkf
  * observer
  * racc
  * resolv-replace
  * rinda
  * syslog

Следующий гем по умолчанию добавлен.

* prism 0.15.1

Следующие гемы по умолчанию обновлены.

* RubyGems 3.5.0.dev
* base64 0.2.0
* benchmark 0.3.0
* bigdecimal 3.1.5
* bundler 2.5.0.dev
* cgi 0.4.0
* csv 3.2.8
* date 3.3.4
* delegate 0.3.1
* drb 2.2.0
* english 0.8.0
* erb 4.0.3
* etc 1.4.3.dev.1
* fcntl 1.1.0
* fiddle 1.1.2
* fileutils 1.7.2
* find 0.2.0
* getoptlong 0.2.1
* io-console 0.6.1.dev
* irb 1.8.3
* logger 1.6.0
* mutex_m 0.2.0
* net-http 0.4.0
* net-protocol 0.2.2
* nkf 0.1.3
* observer 0.1.2
* open-uri 0.4.0
* open3 0.2.0
* openssl 3.2.0
* optparse 0.4.0
* ostruct 0.6.0
* pathname 0.3.0
* pp 0.5.0
* prettyprint 0.2.0
* pstore 0.1.3
* psych 5.1.1.1
* rdoc 6.6.0
* reline 0.3.9
* rinda 0.2.0
* securerandom 0.3.0
* shellwords 0.2.0
* singleton 0.2.0
* stringio 3.0.9
* strscan 3.0.7
* syntax_suggest 1.1.0
* tempfile 0.2.0
* time 0.3.0
* timeout 0.4.1
* tmpdir 0.2.0
* tsort 0.2.0
* un 0.3.0
* uri 0.13.0
* weakref 0.1.3
* win32ole 1.8.10
* yaml 0.3.0
* zlib 3.1.0

Следующий гем, включенный по умолчанию, продвигается из гемов по умолчанию.

* racc 1.7.3

Следующие гемы, включенные по умолчанию, обновлены.

* minitest 5.20.0
* rake 13.1.0
* test-unit 3.6.1
* rexml 3.2.6
* rss 0.3.0
* net-imap 0.4.4
* net-smtp 0.4.0
* rbs 3.2.2
* typeprof 0.21.8
* debug 1.8.0

Для получения дополнительной информации о стандартных и пакетных гемах обратитесь к GitHub-релизам, таким как [Logger](https://github.com/ruby/logger/releases) или к изменениям в журнале изменений.

Подробности о новостях смотрите в [NEWS](https://github.com/ruby/ruby/blob/{{ release.tag }}/NEWS.md)
или [логах коммитов](https://github.com/ruby/ruby/compare/v3_2_0...{{ release.tag }})
для получения дополнительной информации.

С учетом этих изменений, [{{ release.stats.files_changed }} файлов изменено, {{ release.stats.insertions }} добавлено(+), {{ release.stats.deletions }} удалено(-)](https://github.com/ruby/ruby/compare/v3_2_0...{{ release.tag }}#file_bucket)
с момента Ruby 3.2.0!

## Скачать

* <{{ release.url.gz }}>

      SIZE: {{ release.size.gz }}
      SHA1: {{ release.sha1.gz }}
      SHA256: {{ release.sha256.gz }}
      SHA512: {{ release.sha512.gz }}

* <{{ release.url.xz }}>

      SIZE: {{ release.size.xz }}
      SHA1: {{ release.sha1.xz }}
      SHA256: {{ release.sha256.xz }}
      SHA512: {{ release.sha512.xz }}

* <{{ release.url.zip }}>

      SIZE: {{ release.size.zip }}
      SHA1: {{ release.sha1.zip }}
      SHA256: {{ release.sha256.zip }}
      SHA512: {{ release.sha512.zip }}

## Что такое Ruby

Ruby был разработан Мацем (Юкихиро Мацумото) в 1993 году и сейчас развивается как открытое программное обеспечение. Он работает на множестве платформ и широко используется по всему миру, особенно в веб-разработке.
