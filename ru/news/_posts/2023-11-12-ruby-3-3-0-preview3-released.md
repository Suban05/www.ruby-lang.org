---
layout: news_post
title: "Выпуск Ruby 3.3.0-preview3"
author: "naruse"
translator: "suban05"
date: 2023-11-12 00:00:00 +0000
lang: ru
---

{% assign release = site.data.releases | where: "version", "3.3.0-preview3" | first %}
Мы рады объявить о выпуске Ruby {{ release.version }}. Ruby 3.3 добавляет новый парсер под названием Prism, использует Lrama в качестве генератора парсеров, добавляет новый чисто-руби компилятор JIT под названием RJIT и множество улучшений производительности, особенно YJIT.

## Prism

* Введен [парсер Prism](https://github.com/ruby/prism) в качестве гема по умолчанию
  * Prism - это переносимый, устойчивый к ошибкам и поддерживаемый рекурсивный спуск парсер для языка Ruby.
* Prism готов к использованию в продакшене и активно поддерживается, его можно использовать вместо Ripper.
  * Есть [обширная документация](https://ruby.github.io/prism/) по использованию Prism.
  * Prism представляет собой как C-библиотеку, которая будет использоваться внутренне CRuby, так и Ruby гем, который может быть использован любыми инструментами, нуждающимися в парсинге Ruby кода.
  * Известные методы в API Prism:
    * `Prism.parse(source)` - возвращает AST как часть ParseResult.
    * `Prism.dump(source)` - возвращает сериализованный AST в виде строки.
    * `Prism.parse_comments(source)` - возвращает комментарии.
* Вы можете создавать pull request'ы или открывать issues напрямую на [репозитории Prism](https://github.com/ruby/prism), если вам интересно внести вклад.

## Использование Lrama вместо Bison

* Заменен Bison на [Lrama LALR генератор парсеров](https://github.com/yui-knk/lrama) [Feature #19637](https://bugs.ruby-lang.org/issues/19637)
  * Если вас интересует, ознакомьтесь с [Будущее визионера Ruby Parser](https://rubykaigi.org/2023/presentations/spikeolaf.html)
  * Внутренний парсер Lrama заменен на LR парсер, сгенерированный Racc для лучшей поддерживаемости.
  * Поддерживаются параметры правил `(?, *, +)`, они будут использоваться в Ruby parse.y.

## RJIT

* Введен чисто-рубиновый компилятор JIT RJIT, заменивший MJIT.
  * RJIT поддерживает только архитектуру x86-64 на Unix платформах.
  * В отличие от MJIT, он не требует наличия компилятора C во время выполнения.
* RJIT существует только в экспериментальных целях.
  * Для продакшена следует продолжать использовать YJIT.
  * Если вас интересует разработка JIT для Ruby, ознакомьтесь с [презентацией k0kubun на Day 3 RubyKaigi](https://rubykaigi.org/2023/presentations/k0kubun.html#day3).

## YJIT

* Значительные улучшения производительности по сравнению с 3.2
  * Улучшена поддержка splat и rest аргументов.
  * Регистры выделяются для операций стека виртуальной машины.
  * Компилируются больше вызовов с необязательными аргументами.
  * Также компилируются обработчики исключений.
  * Переменные экземпляра больше не выходят в интерпретатор с мегаморфными формами объектов.
  * Неподдерживаемые типы вызовов больше не выходят в интерпретатор.
  * `Integer#!=`, `String#!=`, `Kernel#block_given?`, `Kernel#is_a?`,
    `Kernel#instance_of?`, `Module#===` специально оптимизированы.
  * Теперь более чем в 3 раза быстрее интерпретатора на optcarrot!
* Значительно улучшено использование памяти по сравнению с 3.2
  * Метаданные для скомпилированного кода используют намного меньше памяти.
  * Генерируется более компактный код на ARM64.
* Скорость компиляции теперь немного выше, чем в 3.2.
* Добавлена возможность `RubyVM::YJIT.enable`, которая может включать YJIT во время выполнения.
  * Вы можете запустить YJIT без изменения аргументов командной строки или переменных окружения.
  * Это также может быть использовано для включения YJIT только после загрузки вашего приложения. `--yjit-disable` может использоваться, если вы хотите использовать другие параметры YJIT при отключении YJIT при загрузке.
* Добавлена опция для отключения GC кода и рассмотрения `--yjit-exec-mem-size` как жесткого лимита.
  * Может обеспечить лучшее поведение копирования при записи на серверах с использованием unicorn и forking.
* Статистика `ratio_in_yjit`, произведенная `--yjit-stats`, теперь доступна в релизных сборках, для доступа к большинству статистических данных больше не требуется специальная статистическая или dev сборка.
* Опция трассировки выхода теперь поддерживает выборку
  * `--trace-exits-sample-rate=N`
* `--yjit-perf` добавлен для упрощения профилирования с помощью Linux perf.
* Более тщательное тестирование и множество исправлений ошибок

### Планировщик потоков M:N

* Введен планировщик потоков M:N. [[Feature #19842]](https://bugs.ruby-lang.org/issues/19842)
  * Потоки Ruby M управляются N нативными потоками (потоками ОС), что снижает затраты на создание и управление потоками.
  * Это может нарушить совместимость с C-расширениями, поэтому планировщик потоков M:N по умолчанию отключен в основном Ractor.
      * Переменная среды `RUBY_MN_THREADS=1` включает потоки M:N в основном Ractor.
      * Потоки M:N включены в неосновных Ractor.
  * Переменная среды `RUBY_MAX_CPU=n` устанавливает максимальное количество `N` (максимальное число нативных потоков). Значение по умолчанию — 8.
      * Поскольку одновременно может выполняться только один поток Ruby на Ractor, будет использоваться меньшее из числа, указанного в `RUBY_MAX_CPU`, и количества запущенных Ractor. Таким образом, приложения с одним Ractor будут использовать 1 нативный поток.
      * Для поддержки блокирующих операций можно использовать более `N` нативных потоков.

## Другие заметные новые функции



### Улучшения производительности

* `defined?(@ivar)` оптимизирован с помощью Object Shapes.
* Разрешение имен, такое как `Socket.getaddrinfo`, теперь можно прерывать (в средах, где доступны pthreads). [Feature #19965](https://bugs.ruby-lang.org/issues/19965)
  * В этом случае pthread создается при каждом вызове getaddrinfo или getnameinfo. Это влечет за собой некоторые накладные расходы на разрешение имен (примерно в 2,5 раза по нашим экспериментам). Мы не ожидаем, что эти накладные расходы на разрешение имен будут проблемой для большинства приложений, но если вы заметите такие проблемы или увидите неожиданные эффекты, которые, по вашему мнению, связаны с этим изменением, пожалуйста, сообщите об этом.
* Добавлена переменная среды `RUBY_GC_HEAP_REMEMBERED_WB_UNPROTECTED_OBJECTS_LIMIT_RATIO`. [Feature #19571](https://bugs.ruby-lang.org/issues/19571)
* Дети старых объектов теперь не сразу перемещаются в старшее поколение в сборщике мусора. [Feature #19678](https://bugs.ruby-lang.org/issues/19678)
* Поддержка слабых ссылок добавлена в сборщик мусора. [Feature #19783](https://bugs.ruby-lang.org/issues/19783)

## Другие значимые изменения с версии 3.2

### IRB

IRB получил несколько улучшений, включая, но не ограничиваясь:

- Расширенная интеграция `irb:rdbg`, обеспечивающая опыт отладки, эквивалентный `pry-byebug` ([документация](https://github.com/ruby/irb#debugging-with-irb)).
- Поддержка страницы для команд `ls`, `show_source` и `show_cmds`.
- Более точная и полезная информация, предоставляемая командами `ls` и `show_source`.
- Экспериментальное автодополнение с использованием анализа типов ([документация](https://github.com/ruby/irb#type-based-completion)).
- Теперь возможно изменять цвет текста и стиль шрифта в диалоге автодополнения с помощью введенного класса Reline::Face ([документация](https://github.com/ruby/ruby/blob/master/doc/reline/face.md))

Кроме того, IRB также претерпел обширную рефакторизацию и получил десятки исправлений ошибок для облегчения будущих улучшений.

## Проблемы совместимости

Примечание: Исключая исправления ошибок функций.

### Удаленные константы

Следующие устаревшие константы удалены.



### Удаленные методы

Следующие устаревшие методы удалены.

### Удаленные переменные среды

Следующие устаревшие переменные среды удалены.

* Переменная среды `RUBY_GC_HEAP_INIT_SLOTS` устарела и не работает. Вместо нее используйте переменные среды `RUBY_GC_HEAP_{0,1,2,3,4}_INIT_SLOTS`. [Feature #19785](https://bugs.ruby-lang.org/issues/19785)

## Проблемы совместимости стандартной библиотеки

### `ext/readline` устарел

* У нас есть `reline`, чистая реализация на Ruby, совместимая с API `ext/readline`. Мы полагаемся на `reline` в будущем. Если вам нужно использовать `ext/readline`, вы можете установить `ext/readline` через rubygems.org с помощью `gem install readline-ext`.
* Теперь больше не нужно устанавливать библиотеки типа `libreadline` или `libedit`.

## Обновления C API

### Обновленные C API

Следующие API обновлены.



### Удаленные C API

Следующие устаревшие API удалены.



## Обновления стандартной библиотеки

RubyGems и Bundler предупреждают пользователей, если требуется гем, который запланирован для включения в будущих версиях Ruby.

Целевые библиотеки:

  * abbrev
  * base64
  * bigdecimal
  * csv
  * drb
  * getoptlong
  * mutex_m
  * nkf
  * observer
  * racc
  * resolv-replace
  * rinda
  * syslog

Следующий гем по умолчанию добавлен.

* prism 0.15.1

Следующие гемы по умолчанию обновлены.

* RubyGems 3.5.0.dev
* base64 0.2.0
* benchmark 0.3.0
* bigdecimal 3.1.5
* bundler 2.5.0.dev
* cgi 0.4.0
* csv 3.2.8
* date 3.3.4
* delegate 0.3.1
* drb 2.2.0
* english 0.8.0
* erb 4.0.3
* etc 1.4.3.dev.1
* fcntl 1.1.0
* fiddle 1.1.2
* fileutils 1.7.2
* find 0.2.0
* getoptlong 0.2.1
* io-console 0.6.1.dev
* irb 1.8.3
* logger 1.6.0
* mutex_m 0.2.0
* net-http 0.4.0
* net-protocol 0.2.2
* nkf 0.1.3
* observer 0.1.2
* open-uri 0.4.0
* open3 0.2.0
* openssl 3.2.0
* optparse 0.4.0
* ostruct 0.6.0
* pathname 0.3.0
* pp 0.5.0
* prettyprint 0.2.0
* pstore 0.1.3
* psych 5.1.1.1
* rdoc 6.6.0
* reline 0.3.9
* rinda 0.2.0
* securerandom 0.3.0
* shellwords 0.2.0
* singleton 0.2.0
* stringio 3.0.9
* strscan 3.0.7
* syntax_suggest 1.1.0
* tempfile 0.2.0
* time 0.3.0
* timeout 0.4.1
* tmpdir 0.2.0
* tsort 0.2.0
* un 0.3.0
* uri 0.13.0
* weakref 0.1.3
* win32ole 1.8.10
* yaml 0.3.0
* zlib 3.1.0

Следующий гем, включенный по умолчанию, продвигается из гемов по умолчанию.

* racc 1.7.3

Следующие гемы, включенные по умолчанию, обновлены.

* minitest 5.20.0
* rake 13.1.0
* test-unit 3.6.1
* rexml 3.2.6
* rss 0.3.0
* net-imap 0.4.4
* net-smtp 0.4.0
* rbs 3.2.2
* typeprof 0.21.8
* debug 1.8.0

Для получения дополнительной информации о стандартных и пакетных гемах обратитесь к GitHub-релизам, таким как [Logger](https://github.com/ruby/logger/releases) или к изменениям в журнале изменений.

Подробности о новостях смотрите в [NEWS](https://github.com/ruby/ruby/blob/{{ release.tag }}/NEWS.md)
или [логах коммитов](https://github.com/ruby/ruby/compare/v3_2_0...{{ release.tag }})
для получения дополнительной информации.

С учетом этих изменений, [{{ release.stats.files_changed }} файлов изменено, {{ release.stats.insertions }} добавлено(+), {{ release.stats.deletions }} удалено(-)](https://github.com/ruby/ruby/compare/v3_2_0...{{ release.tag }}#file_bucket)
с момента Ruby 3.2.0!

## Скачать

* <{{ release.url.gz }}>

      SIZE: {{ release.size.gz }}
      SHA1: {{ release.sha1.gz }}
      SHA256: {{ release.sha256.gz }}
      SHA512: {{ release.sha512.gz }}

* <{{ release.url.xz }}>

      SIZE: {{ release.size.xz }}
      SHA1: {{ release.sha1.xz }}
      SHA256: {{ release.sha256.xz }}
      SHA512: {{ release.sha512.xz }}

* <{{ release.url.zip }}>

      SIZE: {{ release.size.zip }}
      SHA1: {{ release.sha1.zip }}
      SHA256: {{ release.sha256.zip }}
      SHA512: {{ release.sha512.zip }}

## Что такое Ruby

Ruby был разработан Мацем (Юкихиро Мацумото) в 1993 году и сейчас развивается как открытое программное обеспечение. Он работает на множестве платформ и широко используется по всему миру, особенно в веб-разработке.
